name: Scrape + Deploy + Email

on:
  schedule:
    # exécution CHAQUE HEURE (UTC), puis on filtre dans le job pour ne déployer qu'à 10:00 Europe/Paris (gère l'heure d'été)
    - cron: "0 * * * *"
  workflow_dispatch: {}

jobs:
  build_deploy_notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm ci || npm i
          npx playwright install chromium

      - name: Run scraper (always)
        run: node src/scrape.js

      - name: Decide if it's 10:00 Europe/Paris (DST-safe)
        id: gate
        run: |
          node -e "const {DateTime}=require('luxon'); const now=DateTime.now().setZone('Europe/Paris'); process.stdout.write(now.toFormat('HH')==='10' ? 'ok' : 'skip');"
        shell: bash

      - name: Install Netlify CLI
        if: ${{ steps.gate.outputs.stdout == 'ok' }}
        run: npm i -g netlify-cli

      - name: Deploy to Netlify (prod)
        if: ${{ steps.gate.outputs.stdout == 'ok' }}
        run: |
          netlify deploy --dir=public --prod --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN --message "Daily scrape"
        env:
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}

      - name: Send email notification
        if: ${{ steps.gate.outputs.stdout == 'ok' }}
        uses: dawidd6/action-send-mail@v6
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}   # ex: votre gmail complet
          password: ${{ secrets.MAIL_APP_PASSWORD }} # mot de passe d'application (2FA)
          subject: "Montres — nouvelle page publiée"
          to: "rafael.bchr@gmail.com"
          from: ${{ secrets.MAIL_USERNAME }}
          html_body: |
            <p>Bonjour,</p>
            <p>La page des résultats <strong>Montres</strong> vient d'être régénérée.</p>
            <p>➡️ <a href="https://<votre-sous-domaine-netlify>.netlify.app/montres.html">Ouvrir la page</a></p>
            <p>Bonne journée !</p>
